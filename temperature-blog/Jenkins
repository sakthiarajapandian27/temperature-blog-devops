pipeline {
  agent any

  environment {
    DOCKER_IMAGE = "temperature-blog"
  }

  stages {
    stage('Build') {
      steps {
        echo 'Building Docker Image...'
        sh 'docker build -t $DOCKER_IMAGE .'
      }
    }

    stage('Test') {
      steps {
        echo 'Running Jest Tests...'
        sh 'npm install'
        sh 'npm test'
      }
    }

    stage('Code Quality') {
      steps {
        echo 'Running SonarQube analysis...'
        // replace with your SonarQube CLI or plugin steps
        sh './sonar-scanner -Dsonar.projectKey=temp-blog -Dsonar.sources=.'
      }
    }

    stage('Security Scan') {
      steps {
        echo 'Running Trivy Scan...'
        sh 'trivy image $DOCKER_IMAGE'
      }
    }

    stage('Deploy') {
      steps {
        echo 'Deploying...'
        sh 'docker run -d -p 3000:3000 $DOCKER_IMAGE'
      }
    }

    stage('Release') {
      steps {
        echo 'Tagging Release...'
        sh 'git tag v1.0.${BUILD_NUMBER}'
        sh 'git push origin --tags'
      }
    }

    stage('Monitoring') {
      steps {
        echo 'ðŸ“ˆ Triggering monitoring checks...'
        // Integrate with Datadog, Prometheus, or curl health check
        sh 'curl -s http://localhost:3000 || echo "App not responding"'
      }
    }
  }
}
