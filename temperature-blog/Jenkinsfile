pipeline {
  agent any

  stages {
    stage('Build') {
      steps {
        echo 'ðŸ”§ Building Docker image...'
        dir('temperature-blog') {
          bat 'docker build -t temperature-blog-app .'
        }
      }
    }

    stage('Test') {
      steps {
        echo 'ðŸ§ª Running Jest Tests...'
        dir('temperature-blog') {
          bat 'npm install'
          bat 'npm test'
        }
      }
    }

    stage('Code Quality') {
      steps {
        echo 'ðŸ“Š Running SonarQube analysis...'
        dir('temperature-blog') {
          bat '''
            echo Skipping real SonarQube call. To enable:
            echo sonar-scanner -Dsonar.projectKey=temp-blog ^
              -Dsonar.sources=. ^
              -Dsonar.host.url=http://localhost:9000 ^
              -Dsonar.login=your_token_here
          '''
        }
      }
    }

    stage('Security Scan') {
      steps {
        echo 'ðŸ”’ Running Trivy Scan on Docker image...'
        dir('temperature-blog') {
          bat 'trivy image temperature-blog-app || echo Trivy scan complete (optional)'
        }
      }
    }

    stage('Deploy') {
      steps {
        echo 'ðŸš€ Deploying Container on Port 3000...'
        dir('temperature-blog') {
          bat '''
            docker stop temp-blog-container || echo "No existing container"
            docker rm temp-blog-container || echo "No container to remove"
            docker run -d -p 3000:3000 --name temp-blog-container temperature-blog-app
          '''
        }
      }
    }

    stage('Release') {
      steps {
        echo 'ðŸ“¦ Creating Git Tag (Release)...'
        dir('temperature-blog') {
          bat '''
            git config --global user.email "ci@jenkins.com"
            git config --global user.name "Jenkins CI"
            git tag v1.0.%BUILD_NUMBER%
            git push origin --tags
          '''
        }
      }
    }

    stage('Monitoring') {
      steps {
        echo 'ðŸ“ˆ Performing Localhost Health Check...'
        bat 'curl -s http://localhost:3000 || echo "Health check failed or curl not installed"'
      }
    }
  }
}
