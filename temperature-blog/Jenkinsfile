pipeline {
  agent any

  tools {
    nodejs 'nodejs16' // Make sure this matches the name in Jenkins Global Tool Config
  }

  environment {
    SONAR_PROJECT_KEY = 'temp-blog'
    SONAR_HOST_URL = 'http://localhost:9000'
    SONAR_TOKEN = credentials('sonar-token') // Set this credential ID in Jenkins
  }

  stages {

    stage('Build') {
      steps {
        echo 'ğŸ”§ Building Docker image...'
        dir('temperature-blog') {
          bat 'docker build -t temperature-blog-app .'
        }
      }
    }

    stage('Test') {
      steps {
        echo 'ğŸ§ª Running Jest Tests...'
        dir('temperature-blog') {
          bat 'npm install'
          bat 'npm test'
        }
      }
    }

    stage('Code Quality') {
      steps {
        echo 'ğŸ“Š Running SonarQube analysis...'
        dir('temperature-blog') {
          withSonarQubeEnv('LocalSonar') {
            bat """
              sonar-scanner ^
              -Dsonar.projectKey=${env.SONAR_PROJECT_KEY} ^
              -Dsonar.sources=. ^
              -Dsonar.host.url=${env.SONAR_HOST_URL} ^
              -Dsonar.login=${env.SONAR_TOKEN}
            """
          }
        }
      }
    }

    stage('Security Scan') {
      steps {
        echo 'ğŸ”’ Running Trivy Scan on Docker image...'
        dir('temperature-blog') {
          bat 'trivy image temperature-blog-app || echo Trivy scan complete (optional)'
        }
      }
    }

    stage('Deploy') {
      steps {
        echo 'ğŸš€ Deploying Container on Port 3000...'
        dir('temperature-blog') {
          bat """
            docker stop temp-blog-container || echo "No existing container"
            docker rm temp-blog-container || echo "No container to remove"
            docker run -d -p 3000:3000 --name temp-blog-container temperature-blog-app
          """
        }
      }
    }

    stage('Release') {
      steps {
        echo 'ğŸ“¦ Creating Git Tag (Release)...'
        dir('temperature-blog') {
          bat """
            git config --global user.email "ci@jenkins.com"
            git config --global user.name "Jenkins CI"
            git tag v1.0.%BUILD_NUMBER%
            git push origin --tags
          """
        }
      }
    }

    stage('Monitoring') {
      steps {
        echo 'ğŸ“ˆ Performing Localhost Health Check...'
        bat 'curl -s http://localhost:3000 || echo "Health check failed or curl not installed"'
      }
    }
  }

  post {
    always {
      echo 'âœ… Pipeline execution completed.'
    }
    failure {
      echo 'âŒ Pipeline failed. Please check logs.'
    }
  }
}
