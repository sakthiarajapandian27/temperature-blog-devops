pipeline {
  agent any

  tools {
    nodejs 'NodeJS 18' // Ensure this matches exactly with Jenkins Global Tool Config
  }

  environment {
    SONAR_PROJECT_KEY = 'temperature-blog'
    SONAR_ORG = 'your-sonarcloud-org'  // üîÅ Replace with your actual org key from SonarCloud
    SONAR_HOST_URL = 'https://sonarcloud.io'
    SONAR_TOKEN = credentials('sonar-token') // Must be set in Jenkins Credentials
  }

  stages {

    stage('Build') {
      steps {
        echo 'üîß Building Docker image...'
        dir('temperature-blog') {
          bat 'docker build -t temperature-blog-app .'
        }
      }
    }

    stage('Test') {
      steps {
        echo 'üß™ Running Jest Tests...'
        dir('temperature-blog') {
          bat 'npm install'
          bat 'npm test'
        }
      }
    }

    stage('Code Quality') {
      steps {
        echo 'üìä Running SonarCloud Analysis...'
        dir('temperature-blog') {
          withSonarQubeEnv('SonarCloud') { // Must match name in Jenkins > Configure System
            bat """
              sonar-scanner ^
              -Dsonar.projectKey=%SONAR_PROJECT_KEY% ^
              -Dsonar.organization=%SONAR_ORG% ^
              -Dsonar.sources=. ^
              -Dsonar.host.url=%SONAR_HOST_URL% ^
              -Dsonar.login=%SONAR_TOKEN%
            """
          }
        }
      }
    }

    stage('Security Scan') {
      steps {
        echo 'üîí Running Trivy Vulnerability Scan...'
        dir('temperature-blog') {
          bat 'trivy image temperature-blog-app || echo "‚ö†Ô∏è Trivy scan completed with issues or skipped."'
        }
      }
    }

    stage('Deploy') {
      steps {
        echo 'üöÄ Deploying Docker Container on Port 3000...'
        dir('temperature-blog') {
          bat """
            docker stop temp-blog-container || echo "No existing container"
            docker rm temp-blog-container || echo "No container to remove"
            docker run -d -p 3000:3000 --name temp-blog-container temperature-blog-app
          """
        }
      }
    }

    stage('Release') {
      steps {
        echo 'üì¶ Tagging and Pushing Release to Git...'
        dir('temperature-blog') {
          bat """
            git config --global user.email "ci@jenkins.com"
            git config --global user.name "Jenkins CI"
            git tag v1.0.%BUILD_NUMBER%
            git push origin --tags
          """
        }
      }
    }

    stage('Monitoring') {
      steps {
        echo 'üìà Performing Health Check on Port 3000...'
        bat 'curl -s http://localhost:3000 || echo "‚ö†Ô∏è Health check failed or curl not available."'
      }
    }
  }

  post {
    always {
      echo '‚úÖ Pipeline run completed.'
    }
    failure {
      echo '‚ùå Pipeline failed. Please review stage logs above.'
    }
  }
}
